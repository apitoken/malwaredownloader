#!/bin/bash

# Get some sites
# Australia : wget -q https://urlhaus.abuse.ch/feeds/tld/AU/ csv
# ALL
echo "Downloading urlhaus abuse csv..."
wget -O - https://urlhaus.abuse.ch/downloads/csv | zcat | grep online |  cut -d '"' -f6 | grep exe | uniq | tee -a dwnme


# Get some domains
cat csv | grep online > onlinemalware
cat onlinemalware | cut -d '"' -f6 > urls
#cat csv | cut -d '"' -f12 >> ip addresses
cat urls | grep exe > dwnme 

# Move to malware folder
mkdir -p malware 2>/dev/null
cd malware
echo "Downloading malware..."

# Download and look at the malware
while read p; do
	wget -q --tries=1 "$p" > /dev/null
	file=$(basename $p)
	
	echo "File: "$file " from " $p 

	#Put in here text file dictionary to test for interesting words that may be available
	strings -a $file | grep hack > interesting
	if [ -s interesting ]
	then
		echo "Interesting Strings Detected: "
		cat interesting
		rm interesting
	fi

	strings -a $file | grep -e '[^\ ]\{30,\}' > stringsdetected
	#if [ -s stringsdetected ]
	#then
	#	echo "Long Strings:"
	#	cat stringsdetected
	#fi

	
	#Detected Windows Version Strings
	cat stringsdetected | grep "8e0f7a12-bfb3-4fe8-b9a5-48fd50a15a9a" > win10
	cat stringsdetected | grep "1f676c76-80e1-4239-95bb-83d0f6d0da78" > win81
	cat stringsdetected | grep "4a2f28e3-53b9-4441-ba9c-d69d4a4a6e38" > win80
	cat stringsdetected | grep "35138b9a-5d96-4fbd-8e2d-a2440225f93a" > win70
	cat stringsdetected | grep "e2011457-1546-43c5-a5fe-008deee3d3f0" > winvi

	if [ -s win10 ]
	then
		echo "Windows 10 / Windows Server 2016 Targetting Detected"
		rm win10
	fi

	if [ -s win81 ]
	then
		echo "Windows 8.1 / Windows Server 2012 R2 Targetting Detected"
		rm win81	
	fi

	if [ -s win80 ]
	then
		echo "Windows 8.0 / Windows Server 2012 Targetting Detected"
		rm win80
	fi

	if [ -s win70 ]
	then
		echo "Windows 7 / Windows Server 2008 R2 Targetting Detected"
		rm win70
	fi

	if [ -s winvi ]
	then
		echo "Windows Vista / Windows Server 2008 Targetting Detected"
		rm winvi
	fi


	#Detect IP Addresses
	strings -a $file | grep -o '[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}' > IPS
	if [ -s IPS ]
	then
		sed '/0.0.0/d' IPS > realIPS
		if [ -s realIPS ]
		then
			echo "IP Addresses Detected: " 
			uniq realIPS
			rm realIPS
		fi
		rm IPS
	fi

	rm stringsdetected	

	echo "-------------------------------------------"
	echo "" && echo ""

done <../dwnme

# Clean Up
cd ..
#cp csv csvold
rm index* onlinemalware* urls* downloadme* 2>/dev/null
